<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.313">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Peter Schmidtke">
<meta name="dcterms.date" content="2021-02-16">
<meta name="description" content="Log of the hassle doing torsion angle scans with rdkit &amp; xtb - ultimately comparing results to the crystallography open database">

<title>Spinning coral - Torsion angle scan with rdkit &amp; xtb</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/bootstrap/bootstrap-dark.min.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script type="module" src="../../../site_libs/quarto-ojs/quarto-ojs-runtime.js"></script>
<link href="../../../site_libs/quarto-ojs/quarto-ojs.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../../styles.scss">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Spinning coral</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/pschmidtke" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://masto.ai/@pschmidtke" rel="" target=""><i class="bi bi-mastodon" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Torsion angle scan with rdkit &amp; xtb</h1>
                  <div>
        <div class="description">
          Log of the hassle doing torsion angle scans with rdkit &amp; xtb - ultimately comparing results to the crystallography open database
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">torsion</div>
                <div class="quarto-category">dihedral</div>
                <div class="quarto-category">oss</div>
                <div class="quarto-category">opensource</div>
                <div class="quarto-category">rdkit</div>
                <div class="quarto-category">xtb</div>
                <div class="quarto-category">energy</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Peter Schmidtke </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 16, 2021</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#aim" id="toc-aim" class="nav-link active" data-scroll-target="#aim">Aim</a></li>
  <li><a href="#dihedral-scan-with-rdkit" id="toc-dihedral-scan-with-rdkit" class="nav-link" data-scroll-target="#dihedral-scan-with-rdkit">Dihedral scan with rdkit</a></li>
  <li><a href="#dihedral-scan-with-xtb" id="toc-dihedral-scan-with-xtb" class="nav-link" data-scroll-target="#dihedral-scan-with-xtb">Dihedral scan with xtb</a></li>
  <li><a href="#comparing-vs-cod" id="toc-comparing-vs-cod" class="nav-link" data-scroll-target="#comparing-vs-cod">Comparing vs COD</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>Post #4 will be along the lines of dihedral / torsion angle analysis again. The aim is to log some of the hurdles I had to overcome to run a torsion angle analysis with <a href="https://github.com/grimme-lab/xtb">xtb</a> and / or <a href="https://www.rdkit.org/">rdkit</a>.</p>
<p>What I’m trying to accomplish here is mainly to see how torsion angle scans can be performed - easily and robustly - using open source tools available. This is in preparation of a larger work track on analysing the data from the <a href="http://www.crystallography.net/cod/">COD</a>, where <a href="https://pschmidtke.github.io/blog/rdkit/crystallography/small%20molecule%20xray/xray/database/2021/01/25/cod-and-torsion-angles.html">first steps have already been set here</a>.</p>
<section id="aim" class="level2">
<h2 class="anchored" data-anchor-id="aim">Aim</h2>
<p>Given an input molecule and a particular torsion angle I’d like to see what the energy langscape of the molecule looks like when rotating around that torsion angle. I’d like to know how easy/complicated this is using two different tools:</p>
<ol type="1">
<li><strong>rdkit</strong> with the integrated MMFF</li>
<li><strong>xtb</strong> from the Grimme lab</li>
</ol>
<p>The post is also inspired by an older <a href="https://iwatobipen.wordpress.com/2020/09/06/visualize-the-torsion-drive-with-different-approach-openff-torchani-chemoinformatics-quantum_chemistry/">post done by iwatobipen</a> analyzing openforcefield with Ani2 on some torsion energy predictions using the <a href="https://qcarchivetutorials.readthedocs.io/en/latest/basic_examples/torsiondrive_datasets.html">torsion drive dataset from the openforcefield initiative</a></p>
<p>All code used for this post is available on <a href="https://github.com/pschmidtke/dihedral_scans/tree/main/notebooks">this separate repo</a>, as it uses a slightly different environment (you’ll see why).</p>
</section>
<section id="dihedral-scan-with-rdkit" class="level2">
<h2 class="anchored" data-anchor-id="dihedral-scan-with-rdkit">Dihedral scan with rdkit</h2>
<p>I don’t really know why, but I started out with this molecule here:</p>
<div class="cell" data-execution_count="1">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit <span class="im">import</span> Chem</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem <span class="im">import</span> AllChem</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem <span class="im">import</span> Draw</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>mol<span class="op">=</span>Chem.AddHs(Chem.MolFromSmiles(<span class="st">'CCCOC1=CC=C(Cl)C(C)=C1'</span>))</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, a <span class="kw">in</span> <span class="bu">enumerate</span>(mol.GetAtoms()):</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>        a.SetAtomMapNum(i)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>AllChem.EmbedMolecule(mol,randomSeed<span class="op">=</span><span class="dv">10</span>)    <span class="co">#generate an initial random conformation (randomSeed is fixed to have something reproducible)</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">#mol</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>Draw.MolToFile(mol,<span class="st">"mol.png"</span>,includeAtomNumbers<span class="op">=</span><span class="va">True</span>,highlightAtoms<span class="op">=</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>))        <span class="co">#sorry - rdkit 2019.03 issues with newer python versions (I guess)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><img src="mol.png" class="img-fluid"></p>
<p>The torsion angle I’m interested in is highlighted in red and situated between carbons 1,2,3 &amp; 4. Now let’s try to set up a torsion angle scan in rdkit using MMFF (UFF should be similar procedure … )</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem <span class="im">import</span> rdMolTransforms</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> copy</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem <span class="im">import</span> rdForceFieldHelpers</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem <span class="im">import</span> ChemicalForceFields</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rdkit.Chem <span class="im">import</span> rdMolTransforms</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>conformer<span class="op">=</span>mol.GetConformer(<span class="dv">0</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>m2<span class="op">=</span>copy.deepcopy(mol)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>mp2 <span class="op">=</span> AllChem.MMFFGetMoleculeProperties(m2)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>energy<span class="op">=</span>[]</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>confid<span class="op">=</span><span class="dv">0</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>angles<span class="op">=</span><span class="bu">range</span>(<span class="op">-</span><span class="dv">180</span>,<span class="dv">182</span>,<span class="dv">2</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Initial angle:"</span>)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(rdMolTransforms.GetDihedralDeg(conformer,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>))</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> angle <span class="kw">in</span> angles:</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    confid<span class="op">+=</span><span class="dv">1</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    ff2 <span class="op">=</span> AllChem.MMFFGetMoleculeForceField(m2, mp2)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    ff2.MMFFAddTorsionConstraint(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>, <span class="va">False</span>, angle <span class="op">-</span> <span class="fl">.2</span>, angle <span class="op">+</span> <span class="fl">.2</span>, <span class="fl">1000.0</span>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    ff2.Minimize()</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    energy.append(ff2.CalcEnergy())</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    xyz<span class="op">=</span>ff2.Positions()</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    new_conf <span class="op">=</span> Chem.Conformer(mol.GetNumAtoms())</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(mol.GetNumAtoms()):</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>        new_conf.SetAtomPosition(i, (m2.GetConformer(<span class="op">-</span><span class="dv">1</span>).GetAtomPosition(i)))</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    new_conf.SetId(confid)</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    mol.AddConformer(new_conf)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>dfrdkit <span class="op">=</span> pd.DataFrame({<span class="st">'angle'</span>:angles, <span class="st">'energy'</span>:energy})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Initial angle:
179.99983170835984</code></pre>
</div>
</div>
<div class="cell" data-execution_count="3">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#! echo: false</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>sns.lineplot(</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>dfrdkit,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"angle"</span>, y<span class="op">=</span><span class="st">"energy"</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    markers<span class="op">=</span><span class="va">True</span>, dashes<span class="op">=</span><span class="va">False</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>&lt;Axes: xlabel='angle', ylabel='energy'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2021-02-16-torsion-angle-scans-xtb_files/figure-html/cell-4-output-2.png" width="597" height="429"></p>
</div>
</div>
<p><a href="!energyplot.png"></a></p>
<p>I’m printing the angle of the initial conformation here as well &amp; start the scan from around that angle. Before I didn’t and obviously it created a lot of issues with the minimization of the subsequent conformers. Here is the plot from iwatobipen’s post on the same molecule &amp; same torsion scan:</p>
<p><img src="https://iwatobipen.files.wordpress.com/2020/09/mol3.png?w=920" class="img-fluid"></p>
<p>Let’s first have a look at the minimized conformers. Here’s a bit of code to browse through them. I collected all conformations generated with the torsion scan before.</p>
<div class="cell" data-execution_count="4">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>patt <span class="op">=</span> Chem.MolFromSmarts(<span class="st">'c1ccccc1'</span>)<span class="op">;</span>patt</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>match <span class="op">=</span> mol.GetSubstructMatch(patt)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>AllChem.AlignMolConformers(mol,atomIds<span class="op">=</span>match)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>conformerIds<span class="op">=</span>[conf.GetId() <span class="cf">for</span> conf <span class="kw">in</span> mol.GetConformers()]</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>w <span class="op">=</span> Chem.SDWriter(<span class="st">"conformers.sdf"</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cid <span class="kw">in</span> <span class="bu">range</span>(mol.GetNumConformers()):</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    w.write(mol, confId<span class="op">=</span>cid)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>w.close()</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>ojs_define(conformerIds<span class="op">=</span><span class="bu">list</span>(conformerIds))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="ojs-define">{"contents": [{"name": "conformerIds", "value": [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 181]}]}</script>
</div>
</div>
<div class="cell panel-input card bg-light p-2">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb7" data-startfrom="156" data-source-offset="-23"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 155;"><span id="cb7-156"><a href="#cb7-156" aria-hidden="true" tabindex="-1"></a>NGL<span class="op">=</span><span class="pp">require</span>(<span class="st">"ngl@next"</span>)</span>
<span id="cb7-157"><a href="#cb7-157" aria-hidden="true" tabindex="-1"></a>viewof trajInput <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>([<span class="dv">1</span><span class="op">,</span> conformerIds<span class="op">.</span><span class="at">length</span>]<span class="op">,</span> {<span class="dt">value</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">step</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"Conformer ID"</span>})<span class="op">;</span></span>
<span id="cb7-158"><a href="#cb7-158" aria-hidden="true" tabindex="-1"></a><span class="fu">md</span><span class="vs">`Conformer ID: </span><span class="sc">${</span>conformerIds[trajInput <span class="op">-</span> <span class="dv">1</span>]<span class="sc">}</span><span class="vs">`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-3" data-nodetype="expression">

</div>
</div>
</div>
</div>
<div class="cell">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb8" data-startfrom="163" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 162;"><span id="cb8-163"><a href="#cb8-163" aria-hidden="true" tabindex="-1"></a><span class="co">// Create drawing area</span></span>
<span id="cb8-164"><a href="#cb8-164" aria-hidden="true" tabindex="-1"></a>divNGLConf <span class="op">=</span> <span class="fu">html</span><span class="vs">`&lt;div style="width:500px;height:400px;position:relative"&gt;&lt;/div&gt;`</span><span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details class="hidden">
<summary>Code</summary>
<div class="sourceCode cell-code hidden" id="cb9" data-startfrom="175" data-source-offset="-30"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 174;"><span id="cb9-175"><a href="#cb9-175" aria-hidden="true" tabindex="-1"></a>trajPDB <span class="op">=</span> {</span>
<span id="cb9-176"><a href="#cb9-176" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> stage <span class="op">=</span> <span class="kw">new</span> NGL<span class="op">.</span><span class="fu">Stage</span>(divNGLConf<span class="op">,</span> {<span class="dt">clipDist</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span> <span class="dt">backgroundColor</span><span class="op">:</span> <span class="st">"black"</span>})<span class="op">;</span></span>
<span id="cb9-177"><a href="#cb9-177" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> pdbString <span class="op">=</span> <span class="cf">await</span> <span class="fu">FileAttachment</span>(<span class="st">"conformers.sdf"</span>)<span class="op">.</span><span class="fu">blob</span>()<span class="op">;</span></span>
<span id="cb9-178"><a href="#cb9-178" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> structure <span class="op">=</span> <span class="cf">await</span> stage<span class="op">.</span><span class="fu">loadFile</span>(pdbString<span class="op">,</span> {<span class="dt">ext</span><span class="op">:</span> <span class="st">"sdf"</span><span class="op">,</span> <span class="dt">asTrajectory</span><span class="op">:</span> <span class="kw">true</span>})</span>
<span id="cb9-179"><a href="#cb9-179" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> traj <span class="op">=</span> structure<span class="op">.</span><span class="fu">addTrajectory</span>()<span class="op">.</span><span class="at">trajectory</span></span>
<span id="cb9-180"><a href="#cb9-180" aria-hidden="true" tabindex="-1"></a>  structure<span class="op">.</span><span class="fu">addRepresentation</span>(<span class="st">"licorice"</span>)<span class="op">;</span></span>
<span id="cb9-181"><a href="#cb9-181" aria-hidden="true" tabindex="-1"></a>  structure<span class="op">.</span><span class="fu">autoView</span>()<span class="op">;</span></span>
<span id="cb9-182"><a href="#cb9-182" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> traj<span class="op">;</span></span>
<span id="cb9-183"><a href="#cb9-183" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb9-184"><a href="#cb9-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-185"><a href="#cb9-185" aria-hidden="true" tabindex="-1"></a><span class="co">// Create function to update trajectory</span></span>
<span id="cb9-186"><a href="#cb9-186" aria-hidden="true" tabindex="-1"></a>update_traj <span class="op">=</span> <span class="kw">function</span>(traj<span class="op">,</span> id){</span>
<span id="cb9-187"><a href="#cb9-187" aria-hidden="true" tabindex="-1"></a>  traj<span class="op">.</span><span class="fu">setFrame</span>(id)</span>
<span id="cb9-188"><a href="#cb9-188" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb9-189"><a href="#cb9-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-190"><a href="#cb9-190" aria-hidden="true" tabindex="-1"></a><span class="co">// Update trajectory based on slider</span></span>
<span id="cb9-191"><a href="#cb9-191" aria-hidden="true" tabindex="-1"></a><span class="fu">update_traj</span>(trajPDB<span class="op">,</span> trajInput <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-3-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-3-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display hidden">
<div>
<div id="ojs-cell-3-3" data-nodetype="expression">

</div>
</div>
</div>
</div>
<p>You can use the slider above to browse through the first conformers. They look fairly reasonable to me so far.</p>
<p>Even though we can observe a peak around 0° that is common between what I have here &amp; iwatobipens post. The wells around -75° and 75° are not that easily distinguishible unfortunately.</p>
</section>
<section id="dihedral-scan-with-xtb" class="level2">
<h2 class="anchored" data-anchor-id="dihedral-scan-with-xtb">Dihedral scan with xtb</h2>
<p>XTB is a toolkit implementing semiempirical quantum mechanics and you can do quite a lot of things. Among these: energy optimization, dihedral scans, constrained optimizations, metadynamics etc…It’s conda packaged, so easy to deploy anywhere. In contrary to things like Gaussian, Jaguar etc, it’s:</p>
<ol type="1">
<li>free</li>
<li>opensource</li>
<li>actually quite fast</li>
</ol>
<p>Running an energy optimization with xtb is rather straightforward and would work like this:</p>
<p><code>xtb mol.sdf --opt --charge 0</code></p>
<p>This will write the optimized molecule in an SD file, together with the energy (in hartree).</p>
<p>XTB also supports dihedral scans as described in the documentation and the <a href="https://xtb-docs.readthedocs.io/en/latest/scan.html#ethane">examples work well on ethane</a>. The thing is, as usual … we are not working with ethane or 1-Bromo-2-chloroethane (the other example).</p>
<p>Long story short, I tried to integrate a dihedral scan as described in the documentation, but on my molecule above (which still remains rather simple)</p>
<p>This resulted in a ton of segmentation faults (fond memories of Gaussian came back to me) after a few dihedral scan cycles. My suspicion is that the xtb optimizer is not robust enough to allow to resolve really ugly clashes generated during the scan (I’m just guessing here).</p>
<p>So here’s the workaround I came up with: preparing “good enough” starting conformations with rdkit and constrained optimizing with xtb and last, gathering the final energy values.</p>
<div class="cell" data-execution_count="5">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># angles=range(-180,180,5)</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>xtbenergy<span class="op">=</span>[]</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>w <span class="op">=</span> Chem.SDWriter(<span class="st">'mol.sdf'</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>w.write(mol,confId<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>w.close()</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">#loop over the previous conformations we obtained with rdkit</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx,deg <span class="kw">in</span> <span class="bu">enumerate</span>(angles):</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   Chem.MolToMolFile(mol,'molecule.mol')</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  atoms <span class="op">=</span> <span class="st">'2,3,4,5'</span> <span class="co">#set atoms to define the dihedral - NB: xtb indexes start at 1, rdkit at 0</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Now write the xtb input file:</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  fh <span class="op">=</span> <span class="bu">open</span>(<span class="st">"dihedral_constraint.inp"</span>,<span class="st">"w"</span>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  fh.write(<span class="st">"""$constrain</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="st">    force constant=1.0</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="st">    dihedral: </span><span class="sc">{}</span><span class="st">,</span><span class="sc">{}</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="st">  $end"""</span>.<span class="bu">format</span>(atoms,<span class="bu">float</span>(deg)))</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>  fh.close()</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># run xtb</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> idx<span class="op">==</span><span class="dv">1</span>: </span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    inputfilename<span class="op">=</span><span class="st">"mol.sdf"</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>:</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    inputfilename<span class="op">=</span><span class="st">"xtbopt.sdf"</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  os.popen(<span class="st">"obabel -isdf "</span><span class="op">+</span>inputfilename<span class="op">+</span><span class="st">" -osdf -Oobabelmol.sdf &amp;&amp; export OMP_STACKSIZE=48G &amp;&amp; export OMP_NUM_THREADS=12 &amp;&amp; xtb obabelmol.sdf --opt vtight --charge 0 --input dihedral_constraint.inp"</span>).read()</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">with</span> <span class="bu">open</span>(<span class="st">'xtbopt.sdf'</span>) <span class="im">as</span> f:</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    first_line <span class="op">=</span> f.readline()</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    xtbenergy.append(<span class="bu">float</span>(first_line.split(<span class="st">"gnorm"</span>)[<span class="dv">0</span>].split(<span class="st">":"</span>)[<span class="dv">1</span>]))</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(xtbenergy)</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(angles)</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(dfrdkit[<span class="st">"energy"</span>])</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>sns.lineplot(</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>dfrdkit,</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"angle"</span>, y<span class="op">=</span><span class="st">"energy"</span>,</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    markers<span class="op">=</span><span class="va">True</span>, dashes<span class="op">=</span><span class="va">False</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[-36.667513607102, -36.667309140177, -36.667281342484, -36.667239620489, -36.667184526773, -36.667117066126, -36.667037048311, -36.666945068211, -36.666842035773, -36.666727935772, -36.666604060224, -36.666472299839, -36.666331713852, -36.666184708292, -36.666031740213, -36.665874503518, -36.665713626478, -36.665550482059, -36.66538825599, -36.665225539683, -36.665065448331, -36.664908207787, -36.664756200554, -36.664609973167, -36.664471049714, -36.664340711715, -36.664220117532, -36.664110543681, -36.664013292087, -36.663929734669, -36.663861827436, -36.663811930617, -36.663785358953, -36.663798737338, -36.664979277748, -36.66520794, -36.665435059634, -36.665662744478, -36.665885124937, -36.666103090883, -36.66631293046, -36.666513718719, -36.666703584448, -36.666881133011, -36.66704466986, -36.667193605558, -36.667326090946, -36.667441655993, -36.667539140451, -36.667617824736, -36.667676838596, -36.667715513415, -36.667733191444, -36.667729259909, -36.667703174391, -36.667654498956, -36.667582681905, -36.667487621575, -36.667369122472, -36.667227133502, -36.667061760273, -36.666873378488, -36.666662375664, -36.666429356721, -36.666175209343, -36.665900780799, -36.665607020687, -36.665295092731, -36.664966346322, -36.664622108195, -36.664264015668, -36.663893894368, -36.663513617705, -36.663125457688, -36.662731505843, -36.662334108898, -36.661935609452, -36.661538373839, -36.661144767473, -36.660757102954, -36.660377606895, -36.660008348515, -36.659651419864, -36.659308746758, -36.658982148344, -36.65867330741, -36.658383810707, -36.658115108876, -36.657868511125, -36.657644953523, -36.657446596701, -36.657273573907, -36.65712674186, -36.657007487457, -36.656916139656, -36.656853449108, -36.656820030572, -36.65681652035, -36.656843563867, -36.656901487252, -36.656991065908, -36.657113141754, -36.657268773622, -36.657460253667, -36.657691643264, -36.657995009871, -36.658377284791, -36.658734779587, -36.659101032723, -36.65947082494, -36.65983907601, -36.660205762865, -36.660568445789, -36.660925547559, -36.661276290406, -36.661622045455, -36.661961151255, -36.662293542142, -36.662618617756, -36.662935539654, -36.663243196539, -36.663539682536, -36.663825629787, -36.664097088781, -36.66435469442, -36.664595178208, -36.664818301433, -36.66502278909, -36.665207515844, -36.66537160691, -36.665514564786, -36.665636254032, -36.665736540925, -36.66581574069, -36.665874412542, -36.665913153582, -36.665933064251, -36.665933964303, -36.665917822483, -36.665884812253, -36.665836013797, -36.665772163003, -36.665693615985, -36.665604836221, -36.665503223322, -36.665391578063, -36.665270323778, -36.665142434253, -36.665007952167, -36.664869075563, -36.664728209023, -36.664586960773, -36.664449514058, -36.664316973593, -36.664201080863, -36.664966618261, -36.665079218636, -36.665198049586, -36.665324534034, -36.665457378424, -36.665594877696, -36.665735947942, -36.665879336208, -36.666023480717, -36.666167690138, -36.666309918055, -36.666449518595, -36.666584866403, -36.666714785838, -36.666838170524, -36.666953893713, -36.667061007153, -36.667158583164, -36.667245753906, -36.667321770371, -36.667385989984, -36.667437794223, -36.667476728724, -36.667502584037, -36.667514883009, -36.667513577254]
range(-180, 182, 2)
0      19.936138
1      19.942480
2      19.958324
3      19.989942
4      20.018098
         ...    
176    19.900734
177    19.870128
178    19.849113
179    19.837853
180    19.835944
Name: energy, Length: 181, dtype: float64</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>&lt;Axes: xlabel='angle', ylabel='energy'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2021-02-16-torsion-angle-scans-xtb_files/figure-html/cell-6-output-3.png" width="597" height="429"></p>
</div>
</div>
<p>This runs for a while, but it’s still reasonably fast. Also, you might have noticed that I specified an argument to the <code>--opt</code> flag. This argument allows you to tweak how loose or precise the optimisation should be. More information on that can be found in the <a href="https://xtb-docs.readthedocs.io/en/latest/optimization.html">xtb documentation here</a>. In this example I specified a rather precise method. Feel free to play around with them and check the outcome (rather interesting as well).</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># angle=np.array(range(180,-180,-1))</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>dfxtb <span class="op">=</span> pd.DataFrame({<span class="st">'angle'</span>:angles, <span class="st">'xtb'</span>:xtbenergy,<span class="st">'MMFF'</span>:dfrdkit[<span class="st">"energy"</span>]})</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># dfxtb = pd.DataFrame({'angle':angles, 'xtb':xtbenergy})</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"angle"</span>,y<span class="op">=</span><span class="st">"xtb"</span>,data<span class="op">=</span>dfxtb, color<span class="op">=</span><span class="st">"g"</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> plt.twinx()</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"angle"</span>,y<span class="op">=</span><span class="st">"MMFF"</span>,data<span class="op">=</span>dfxtb, color<span class="op">=</span><span class="st">"b"</span>, ax<span class="op">=</span>ax2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>&lt;Axes: xlabel='angle', ylabel='MMFF'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2021-02-16-torsion-angle-scans-xtb_files/figure-html/cell-7-output-2.png" width="683" height="429"></p>
</div>
</div>
<p>On this plot we can see both results, from rdkit’s MMFF implementation and xtb. Good news…at least they agree on the maximum around 0°. Other than that there are quite important discrepancies on the location of the global minimum and the importance &amp; extent of the energy barriers between them. Interestingly, openFF and ani2 also predict 180° as a global minimum.</p>
</section>
<section id="comparing-vs-cod" class="level2">
<h2 class="anchored" data-anchor-id="comparing-vs-cod">Comparing vs COD</h2>
<p>Let’s double check these results now <a href="https://pschmidtke.github.io/blog/rdkit/crystallography/small%20molecule%20xray/xray/database/2021/01/25/cod-and-torsion-angles.html">with the initial work done on the COD</a> (not yet cleaned and curated - so there will be some noise in here still). This is for sure not the only experimental data-source one should use, but I’ll define it as my golden source of truth here within the scope of this post. First I’ll try to identify the smarts patterns from the torsion library that match the dihedral under investigation here:</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>patterns<span class="op">=</span>pd.read_table(<span class="st">"list_torsion_patterns.txt"</span>,header<span class="op">=</span><span class="va">None</span>,usecols<span class="op">=</span>[<span class="dv">1</span>])</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>selectedPatterns<span class="op">=</span>[]</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> torsionSmarts <span class="kw">in</span> patterns[<span class="dv">1</span>]:</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    torsionQuery <span class="op">=</span> Chem.MolFromSmarts(torsionSmarts)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    matches <span class="op">=</span> mol.GetSubstructMatches(torsionQuery)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="bu">len</span>(matches)<span class="op">&gt;</span><span class="dv">0</span>):</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (matches<span class="op">==</span>((<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>),)):</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>            selectedPatterns.append(torsionQuery)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"selected: "</span>,torsionSmarts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>selected:  [C:1][CX4H2:2]!@;-[OX2:3][c:4]
selected:  [!#1:1][CX4H2:2]!@;-[OX2:3][c:4]
selected:  [C:1][CX4H2:2]!@;-[OX2:3][!#1:4]
selected:  [!#1:1][CX4H2:2]!@;-[OX2:3][!#1:4]
selected:  [!#1:1][CX4:2]!@;-[OX2:3][!#1:4]</code></pre>
</div>
</div>
<p>Now we have the selected patterns, let’s run these through the prepared <a href="https://pschmidtke.github.io/blog/rdkit/crystallography/small%20molecule%20xray/xray/database/2021/01/25/cod-and-torsion-angles.html">COD molecules (a huge local sd file right now)</a> and gather statistics on angles. NB: the smart patterns used here might be redundant and map the same molecules. So here I’m keeping track of which molecule was previously selected and don’t include it in a subsequent calculation anymore:</p>
<div class="cell" data-tags="[]" data-execution_count="8">
<div class="cell-output cell-output-stdout">
<pre><code>[C:1][C&amp;X4&amp;H2:2]!@&amp;-[O&amp;X2:3][c:4]
[!#1:1][C&amp;X4&amp;H2:2]!@&amp;-[O&amp;X2:3][c:4]
[C:1][C&amp;X4&amp;H2:2]!@&amp;-[O&amp;X2:3][!#1:4]
[!#1:1][C&amp;X4&amp;H2:2]!@&amp;-[O&amp;X2:3][!#1:4]
[!#1:1][C&amp;X4:2]!@&amp;-[O&amp;X2:3][!#1:4]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[21:00:06] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:00:06] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:00:07] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:00:10] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:00:12] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:00:19] 

****
Post-condition Violation
Element '6 H' not found
Violation occurred on line 93 in file /Users/runner/miniforge3/conda-bld/rdkit_1678104751770/work/Code/GraphMol/PeriodicTable.h
Failed Expression: anum &gt; -1
****

[21:00:19] ERROR: Element '6 H' not found
[21:00:19] ERROR: moving to the beginning of the next molecule
[21:00:19] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:00:21] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:00:26] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:00:31] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:00:37] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:00:44] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:00:50] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:00:50] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:00:50] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:00:50] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:00:50] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:00:50] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:00:50] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:00:58] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:01:06] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:01:06] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:01:06] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:01:07] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:01:07] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:01:07] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:01:11] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:01:16] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:01:20] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:01:20] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:01:20] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:01:21] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:01:57] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:02:13] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:02:29] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:02:29] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:02:29] Conflicting single bond directions around double bond at index 5.
[21:02:29]   BondStereo set to STEREONONE and single bond directions set to NONE.
[21:02:31] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:02:36] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:02:46] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:02:47] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:02:48] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:02:51] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:02:54] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:03:01] 

****
Post-condition Violation
Element '6 H' not found
Violation occurred on line 93 in file /Users/runner/miniforge3/conda-bld/rdkit_1678104751770/work/Code/GraphMol/PeriodicTable.h
Failed Expression: anum &gt; -1
****

[21:03:01] ERROR: Element '6 H' not found
[21:03:01] ERROR: moving to the beginning of the next molecule
[21:03:02] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:03:04] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:03:10] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:03:14] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:03:22] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:03:30] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:03:36] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:03:36] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:03:36] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:03:36] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:03:36] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:03:36] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:03:36] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:03:45] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:03:54] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:03:54] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:03:54] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:03:54] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:03:55] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:03:55] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:03:59] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:04:05] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:04:09] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:04:09] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:04:09] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:04:10] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:04:49] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:05:04] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:05:21] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:05:22] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:05:22] Conflicting single bond directions around double bond at index 5.
[21:05:22]   BondStereo set to STEREONONE and single bond directions set to NONE.
[21:05:23] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:05:29] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:05:39] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:05:40] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:05:41] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:05:44] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:05:47] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:05:55] 

****
Post-condition Violation
Element '6 H' not found
Violation occurred on line 93 in file /Users/runner/miniforge3/conda-bld/rdkit_1678104751770/work/Code/GraphMol/PeriodicTable.h
Failed Expression: anum &gt; -1
****

[21:05:55] ERROR: Element '6 H' not found
[21:05:55] ERROR: moving to the beginning of the next molecule
[21:05:55] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:05:58] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:06:04] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:06:09] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:06:17] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:06:27] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:06:34] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:06:34] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:06:34] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:06:34] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:06:34] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:06:34] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:06:34] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:06:44] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:06:54] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:06:54] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:06:54] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:06:54] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:06:54] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:06:54] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:06:59] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:07:06] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:07:10] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:07:10] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:07:10] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:07:11] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:07:55] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:08:14] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:08:34] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:08:35] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:08:35] Conflicting single bond directions around double bond at index 5.
[21:08:35]   BondStereo set to STEREONONE and single bond directions set to NONE.
[21:08:37] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:08:43] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:08:56] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:08:57] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:08:58] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:09:02] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:09:05] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:09:14] 

****
Post-condition Violation
Element '6 H' not found
Violation occurred on line 93 in file /Users/runner/miniforge3/conda-bld/rdkit_1678104751770/work/Code/GraphMol/PeriodicTable.h
Failed Expression: anum &gt; -1
****

[21:09:14] ERROR: Element '6 H' not found
[21:09:14] ERROR: moving to the beginning of the next molecule
[21:09:15] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:09:17] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:09:25] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:09:32] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:09:42] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:09:52] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:10:01] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:10:01] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:10:01] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:10:01] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:10:01] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:10:01] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:10:01] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:10:12] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:10:23] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:10:23] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:10:23] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:10:24] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:10:24] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:10:24] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:10:29] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:10:36] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:10:41] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:10:41] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:10:41] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:10:42] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:11:30] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:11:50] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:12:11] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:12:12] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:12:12] Conflicting single bond directions around double bond at index 5.
[21:12:12]   BondStereo set to STEREONONE and single bond directions set to NONE.
[21:12:14] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:12:21] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:12:33] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:12:34] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:12:36] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:12:40] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:12:43] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:12:54] 

****
Post-condition Violation
Element '6 H' not found
Violation occurred on line 93 in file /Users/runner/miniforge3/conda-bld/rdkit_1678104751770/work/Code/GraphMol/PeriodicTable.h
Failed Expression: anum &gt; -1
****

[21:12:54] ERROR: Element '6 H' not found
[21:12:54] ERROR: moving to the beginning of the next molecule
[21:12:55] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:12:58] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:13:07] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:13:14] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:13:27] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:13:37] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:13:47] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:13:47] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:13:47] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:13:47] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:13:47] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:13:47] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:13:47] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:13:59] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:14:11] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:14:11] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:14:11] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:14:11] Warning: molecule is tagged as 3D, but all Z coords are zero
[21:14:12] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:14:12] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:14:17] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:14:25] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:14:30] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:14:30] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:14:31] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:14:32] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:15:26] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:15:49] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:16:14] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:16:14] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:16:14] Conflicting single bond directions around double bond at index 5.
[21:16:14]   BondStereo set to STEREONONE and single bond directions set to NONE.
[21:16:17] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.
[21:16:24] WARNING: could not find number of expected rings. Switching to an approximate ring finding algorithm.</code></pre>
</div>
</div>
<p>This runs again for quite some time…so patience is needed. Once this is done, you should see something like that:</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">#lets convert that to numbers we show in the line-plot together with the previous results</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>angles<span class="op">=</span><span class="bu">range</span>(<span class="op">-</span><span class="dv">180</span>,<span class="dv">182</span>,<span class="dv">2</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>intervals<span class="op">=</span>pd.interval_range(start<span class="op">=-</span><span class="dv">180</span>, end<span class="op">=</span><span class="dv">180</span>,periods<span class="op">=</span><span class="dv">181</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>binangles<span class="op">=</span>pd.cut(angles, bins<span class="op">=</span>intervals).value_counts()</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>dfall <span class="op">=</span> pd.DataFrame({<span class="st">'angle'</span>:angles, <span class="st">'xtb'</span>:xtbenergy,<span class="st">'MMFF'</span>:dfrdkit[<span class="st">"energy"</span>],<span class="st">'cod'</span>:np.array(binangles)})</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>sns.histplot(codangles)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">'Angle'</span>,ylabel<span class="op">=</span> <span class="st">'Count'</span>)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> ax.twinx()</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"angle"</span>,y<span class="op">=</span><span class="st">"xtb"</span>,data<span class="op">=</span>dfall, color<span class="op">=</span><span class="st">"g"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>&lt;Axes: xlabel='angle', ylabel='xtb'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="2021-02-16-torsion-angle-scans-xtb_files/figure-html/cell-10-output-2.png" width="696" height="429"></p>
</div>
</div>
<p>So here we have in blue the results from the COD, in green xtb. Good news is that the positions of the wells seem to be estimated rather well with xtb. MMFF seems slightly off for the preference on 280°. Analysing relative energy differences between local minima, xtb doesn’t follow the trend observed using MMFF &amp; results from the COD here.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Initially I wanted to run this on a larger set of molecules, but as usual things turn out to be much less robust than anticipated. So more to come in an upcoming post, on other torsion angles - especially the challenging ones.</p>
<p>The encouraging aspect here is, that despite all difficulties, one could potentially use this on a larger set of molecules. The instability of xtb on the integrated dihedral scan should be investigated a bit further as well … essentially to make sure that this is not only due to my totally “noob” use of the toolkit - which is very likely.</p>


</section>

</main> <!-- /main -->
<script type="ojs-module-contents">
{"contents":[{"methodName":"interpret","cellName":"ojs-cell-1","inline":false,"source":"// Create input slider\nNGL=require(\"ngl@next\")\nviewof trajInput = Inputs.range([1, conformerIds.length], {value: 1, step: 1, label: \"Conformer ID\"});\nmd`Conformer ID: ${conformerIds[trajInput - 1]}`\n"},{"methodName":"interpret","cellName":"ojs-cell-2","inline":false,"source":"// Create drawing area\ndivNGLConf = html`<div style=\"width:500px;height:400px;position:relative\"></div>`;\n"},{"methodName":"interpret","cellName":"ojs-cell-3","inline":false,"source":"\n// Create trajectory object\n\ntrajPDB = {\n  let stage = new NGL.Stage(divNGLConf, {clipDist: 0.0, backgroundColor: \"black\"});\n  let pdbString = await FileAttachment(\"conformers.sdf\").blob();\n  let structure = await stage.loadFile(pdbString, {ext: \"sdf\", asTrajectory: true})\n  let traj = structure.addTrajectory().trajectory\n  structure.addRepresentation(\"licorice\");\n  structure.autoView();\n  return traj;\n};\n\n// Create function to update trajectory\nupdate_traj = function(traj, id){\n  traj.setFrame(id)\n};\n\n// Update trajectory based on slider\nupdate_traj(trajPDB, trajInput - 1);\n"},{"methodName":"interpretQuiet","source":"shinyInput('trajInput')"}]}
</script>
<script type="module">
if (window.location.protocol === "file:") { alert("The OJS runtime does not work with file:// URLs. Please use a web server to view this document."); }
window._ojs.paths.runtimeToDoc = "../../posts/post-with-code/2021-02-16-torsion-angle-scans-xtb";
window._ojs.paths.runtimeToRoot = "../..";
window._ojs.paths.docToRoot = "../../..";
window._ojs.selfContained = false;
window._ojs.runtime.interpretFromScriptTags();
</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'alternate';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>